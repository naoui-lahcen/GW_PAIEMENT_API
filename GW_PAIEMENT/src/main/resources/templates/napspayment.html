<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
   <head>
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1">
      <title>GATEWAY NAPS</title>

      <!-- CSS -->
      <link rel="stylesheet"
            href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css"
            integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO"
            crossorigin="anonymous">
      <link rel="stylesheet"
            href="https://use.fontawesome.com/releases/v5.0.8/css/all.css">

      <!-- JS -->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js" defer></script>
      <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js"
              integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy"
              crossorigin="anonymous" defer></script>
     <style>
	body {
    	font-family: 'Roboto', sans-serif;
	}
      .dialog {
         display : none;
     }
    @media (max-width: 768px) {
    
    .card-body {
      font-size: 14px;
    }
    .subscribe {
		display: block;
	    width: 100% !important;
	    margin: 5px 0;
	}
	.tr1 {
	color: #DF6537;
    font-size: large !important;
    font-weight: 760;
	}
	.tr2 {
	color: #f27a45f2;
    font-size: larger !important;
    font-weight: 700;
	}
	.tr3 {
	color: #f27a45f2;
    font-size: larger !important;
    font-weight: 700;
	}
   .mobile-hide {
        display: none;
    }
  }

  @media (max-width: 576px) {
   
    .card-body {
      font-size: 12px;
      }
     .subscribe {
		display: block;
	    width: 100% !important;
	    margin: 5px 0;
	}
	.tr1 {
	color: #DF6537;
    font-size: medium !important;
    font-weight: 760;
    margin-top: -40px;
	}
	.tr2 {
	color: #f27a45f2;
    font-size: larger !important;
    font-weight: 700;
	}
	.tr3 {
	color: #f27a45f2;
    font-size: larger !important;
    font-weight: 700;
    margin-top: -40px;
	}
	 .mobile-hide {
        display: none;
    }
    .lydecdata {
		overflow: auto;
	}
	.xxx {
          max-height: 250px;
      }
    .yyy {
           max-height: 574px;
      }
    .cp {
       font-size: 12px;
    }
    }
    table {
		width: 100%;
	}
	td {
		padding-left: 5px;
		border: solid 0.1px #df65374d;
		text-transform: capitalize;
	}
	
	/* Styles pour le popup */
	#processingPopup {
            display: none;
            position: fixed;
            z-index: 9999;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            text-align: center;
        }

        .popup-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
        }
        .loader {
            border: 8px solid #f3f3f3;
            border-top: 8px solid #3498db;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 2s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Styles pour les mobiles */
        @media (max-width: 768px) {
            .popup-content {
                width: 80%;
                padding: 10px;
            }

            .loader {
                width: 40px;
                height: 40px;
                border-width: 6px;
            }
         }
  </style>
   </head>
   <body>
      <div class="container">
<!--         <br class="mobile-hide">-->
         <div class="row" style="margin-bottom: 5px;">
            <aside class="col-sm-12">
            <article class="card">
               <div class="card-body p-2">
                  <img th:src="@{/images/powered_by_naps.png}" alt="Image" style="float:right;width:80px;margin-right:0px;" >
                   <img th:if="${demandeDto.comid == '2104202' or demandeDto.comid == '2210205'}"
                   th:src="@{/images/logo-lydec-color.png}" alt="Image" style="float:left;width:80px;height: 50px;margin-right:0px;" >
               </div>
               <!-- card-body.// -->
            </article>
            </aside>
            <!-- card.// -->
         </div>
<!--         <br class="mobile-hide">-->
         <div class="row" style="margin-bottom: 5px;">
            <aside class="col-sm-12">
            <article class="card">
               <div class="card-body xxx p-5">
                  <p class="text-center tr1" style="color: #DF6537; font-size: xx-large;font-weight: 760;">Espace de paiement
                     en ligne
                  </p>
                  <br class="mobile-hide">
                  <div class="row">
                     <p class="text-right tr2" style="color: #f27a45f2;font-size: x-large;font-weight: 700;">Informations de votre paiement
                     </p>
                  </div>
                  <div class="row">
                     <label for="commande" class="col-sm-6 col-form-label"><strong>Commande :</strong>
                     <span th:text="${demandeDto.commande}"></span>
                     </label>
                     <label for="comid" class="col-sm-6 col-form-label"><strong> Commerçant : </strong>
                     <span th:text="${demandeDto.nameCmr}"></span>
                     </label>
                     <label for="galid" class="col-sm-6 col-form-label"><strong> Site web commerçant : </strong>
                     <span th:text="${demandeDto.siteWeb}"></span>
                     </label>
                     <label for="montant" class="col-sm-6 col-form-label"><strong> Montant à payer : </strong>
                     <span th:text="${demandeDto.montantStr}" style="color: #DF6537;font-weight: 700;"></span> DH
                     </label>
                  </div>

               </div>
            </article>
            </aside>
            <!-- card.// -->
         </div>
<!--         <br class="mobile-hide">-->
         <div class="row" style="margin-bottom: 5px;">
            <aside class="col-sm-12">
            <article class="card">
            <div class="card-body yyy p-5">
               <div class="row">
                  <p class="text-left tr3" style="color: #f27a45f2;font-size: x-large;font-weight: 700;">Informations de votre carte
                  </p>
               </div>
               <form role="form" method="POST" th:action="@{/payer}" th:object="${demandeDto}" onsubmit="showProcessingPopup()">
                  <div class="form-group row">
                     <label for="num" class="col-sm-3 col-form-label"><strong>N°
                     carte bancaire </strong></label>
                     <div class="col-sm-3" th:if="${demandeDto.cartes == null }">
                        <input type="number" th:field="*{demPan}" class="form-control" id="num" required="required"
                           placeholder="Numéro de carte">
                     </div>
                     <div class="col-sm-3" id="cartes" th:if="${demandeDto.cartes != null and demandeDto.cartes.size > 0 }">
                       <select class="form-control" id="carteID" th:field="*{infoCarte}" required="required" onchange="updateExpirationDate()">
                           <option value="Cartes [carte=, pcidsscarte=, year=, mois=, moisValue=]">Séllectionner Carte</option>
                           <option th:each="item : ${demandeDto.cartes}" th:value="${item}" th:text="${item.pcidsscarte}"></option>
                           <option value="Cartes [carte=0000, pcidsscarte=0000, year=0000, mois=0000, moisValue=0000]">Autre Carte</option>
                        </select>
                     </div>
                     <!-- si je clique sur Nouvelle carte jaffiche cette div-->
                     <div class="col-sm-3" id="nvnums" style="display: none;">
                        <input type="number" th:field="*{demPan}" class="form-control" id="nvnum"
                           placeholder="Nouvelle numéro de carte">
                     </div>
                     <label for="cvv" class="col-sm-3 col-form-label"><strong> CVV </strong></label>
                     <div class="col-sm-3">
                        <input type="number" th:field="*{demCvv}" class="form-control" id="cvv" required="required"
                           placeholder="Code à 3 chiffres">
                     </div>
                  </div>
                  <div class="form-group row">
                     <label for="xxx" class="col-sm-3 col-form-label"><strong> Date
                     d'expiration </strong></label>
                     <div class="col-sm-3" th:if="${demandeDto.cartes == null }">
                        <select class="form-control" th:field="*{annee}" required="required">
                           <option value="">Année</option>
                           <option th:each="item : ${demandeDto.years}" th:value="${item}" th:text="${item}"></option>
                        </select>
                     </div>
                     <div class="col-sm-3" id="annees" th:if="${demandeDto.cartes != null and demandeDto.cartes.size > 0}">
                        <input type="number" id="annee"  th:field="*{carte.year}" class="form-control" required="required" disabled>
                     </div>
                     <!-- si je clique sur Nouvelle carte jaffiche cette div-->
                     <div class="col-sm-3" id="nvannes" style="display: none;">
                        <select class="form-control" th:field="*{annee}">
                           <option value="">Année</option>
                           <option th:each="item : ${demandeDto.years}" th:value="${item}" th:text="${item}"></option>
                        </select>
                     </div>
                     <label for="xxx" class="col-sm-3 col-form-label"></label>
                     <div class="col-sm-3" th:if="${demandeDto.cartes == null }">
                        <select class="form-control" th:field="*{mois}" required="required">
                           <option value="">Mois</option>
                           <option th:each="item : ${demandeDto.months}" th:value="${item.value}" th:text="${item.month}"></option>
                        </select>
                     </div>
                     <div class="col-sm-3" id="moiss" th:if="${demandeDto.cartes != null and demandeDto.cartes.size > 0 }">
                         <input type="text" id="mois"  th:field="*{carte.mois}" class="form-control" required="required" disabled>
                     </div>
                      <!-- si je clique sur Nouvelle carte jaffiche cette div-->
                     <div class="col-sm-3" id="nvmois" style="display: none;">
                        <select class="form-control" th:field="*{mois}">
                           <option value="">Mois</option>
                           <option th:each="item : ${demandeDto.months}" th:value="${item.value}" th:text="${item.month}"></option>
                        </select>
                     </div>
                     <input type="hidden" th:field="*{commande}" class="form-control">
                     <input type="hidden" th:field="*{comid}" class="form-control">
                     <input type="hidden" th:field="*{galid}" class="form-control">
                     <input type="hidden" th:field="*{montant}" class="form-control">
                     <input type="hidden" th:field="*{iddemande}" class="form-control">
                     <input type="hidden" th:field="*{failURL}" class="form-control">
                  </div>
                  <div class="form-group row">
					   <!-- Saisir nouvelle carte -->
<!--					<div class="col-md-3" th:if="${demandeDto.cartes != null and demandeDto.cartes.size > 0 }">-->
<!--                     <label>-->
<!--                     <input type="checkbox" th:field="*{flagNvCarte}" id="addNewCardCheckbox" onchange="toggleNewCardFields()"/> Nouvelle carte-->
<!--                     </label>-->
<!--                  </div>-->
                  <!-- Sauvegarder la carte -->
                   <div class="col-md-3" th:if="${demandeDto.idClient != null or demandeDto.token != null}">
                     <label id="saveCard">
                     <input type="checkbox" th:field="*{flagSaveCarte}" /> Sauvegarder la carte
                     </label>
                  </div>
				  </div>
                  <div class="form-group row col-md-12">
                     <label>
                     <input type="checkbox" th:field="*{condition}" required="required" /> J'ai lu et j'accepte
                     </label>
                     <a id="openDialog" style="color: #0056b3;cursor: pointer;text-decoration: underline;margin: 0 2px;">
                     les conditions générales d'utilisation</a>
                  </div>

                  <div class="form-group row">
					  <div class="col-sm-6">
						<img th:src="@{/images/secureicon.png}" alt="Image" style="width: 20px;margin-right: 7px;" >
                        	Toutes vos données personnelles sont cryptées et sécurisées
                     </div>
                     <div class="col-sm-9 float-right">
                        <button type="submit" style="color: #FFF;background: #DF6537;
                           border-radius: 10px;
                           margin-left: auto;
                           width: 160px;
                           border-color: #DF6537;
                           border-top-right-radius: 10px;
                           border-bottom-right-radius: 10px;
                           font-size: 15px;"
                           class="subscribe btn btn-primary btn-block" id="payButton">Payer
                         </button>
                     </div>
                     <div class="col-sm-3 float-right">
                        <button type="button" style="color: #FFF;background: #DF6537;
                           border-radius: 10px;
                           margin-left: auto;
                           width: 160px;
                           border-color: #DF6537;
                           border-top-right-radius: 10px;
                           border-bottom-right-radius: 10px;
                           font-size: 15px;"
                           class="subscribe btn btn-primary btn-block"
                           onclick="cancelPayment()">Annuler
                        </button>
                     </div>

                  </div>
               </form>
            </div>
            </article>
            </aside>
            <!-- card-body.// -->
         </div>
      </div>
      <!-- La div du dialogue -->
      <div id="dialog" class="dialog container my-2" align="center">
         <article class="card" style="max-height: 200px;overflow-y: auto;border: 1px solid #ccc;padding: 10px;">
            <div class="card-body p-5" style="font-size: 15px;">
               <p style="font-weight: bold !important;">
                  Conformément à la loi 09-08 sur la protection des personnes physiques à 
                  l'égard du traitement des données à caractère personnel, il est porté à votre connaissance 
                  qu'en utilisant le service de paiement en ligne pour payer un service ou un produit 
                  commercialisé par un site marchand affilié à NAPS:
               </p>
               <ul style="padding-left: 0;">
                  <li style="color: #f37122;"><span
                     style="color: #000 !important;">
                     Les destinataires des données concernant un payeur telles que le nom et prénom, courriel,
                     adresse et numéro de téléphone, à l'exception des données bancaires confidentielles, 
                     et qui sont soit transmises par le site Marchand à NAPS ou saisies par le payeur sur l'écran de paiement 
                     mis à sa disposition par NAPS pour le compte de l'e-commerçant et sous son ordre, pourront être 
                     utilisées par les collaborateurs de NAPS responsables du traitement, dont la finalité est le suivi
                     de l'opération de paiement initiée par le payeur sur le site Marchand.</span>
                  </li>
                  <br />
                  <li style="color: #f37122;"><span
                     style="color: #000 !important;">
                     Les destinataires des données bancaires qui sont saisies par le payeur sur l'écran de paiement mis à
                     sa disposition par NAPS pour le compte de l'e-commerçant et sous son ordre, pourront être utilisées 
                     par les systèmes d'information et monétiques de NAPS, ainsi que le système monétique de la banque
                     marocaine ou internationale émettrice de la carte bancaire utilisée lors du paiement en ligne.
                     Toutes ces entités sont responsables, chacune suivant ses attributions, du traitement dont la 
                     finalité est le traitement de l'opération de paiement initiée par le payeur sur le site marchand</span>
                  </li>
                  <br />
                  <li style="color: #f37122;"><span
                     style="color: #000 !important;">
                     Les données recueillies par NAPS ne peuvent être utilisées à des fins de prospection par ce dernier
                     et sont la propriété de l'e-commerçant qui a délégué la gestion du paiement de son site marchand à NAPS.</span>
                  </li>
                  <br />
                  <li style="color: #f37122;"><span
                     style="color: #000 !important;">Vous disposez d'un droit 
                     d'accès en consultation à vos données personnelles traitées par NAPS et qui figurent dans votre reçu de paiement,
                     à l'exception des données bancaires, en contactant NAPS par courrier à l'adresse suivante : NAPS - 16, 
                     rue Ibn Khalikane, Palmiers, Casablanca.</span>
                  </li>
                  <br />
                  <li style="color: #f37122;"><span
                     style="color: #000 !important;">
                     Vous pouvez aussi accéder à ces données depuis le reçu de paiement ou de transaction 
                     mis à votre disposition par courriel et en ligne par NAPS ou l'e-commerçant.</span>
                  </li>
                  <br />
                  <li style="color: #f37122;"><span
                     style="color: #000 !important;">
                     Le clic de validation du paiement que vous effectuerez sur l'écran de paiement constitue la validation
                     de votre demande de paiement auprès du site Marchand et vaudra acceptation irrévocable des présentes
                     conditions générales d'utilisation du service de paiement en ligne de NAPS. De ce fait, vous ne 
                     disposerez pas du droit de rectification de vos données personnelles ni de l'annulation de cette
                     demande de paiement auprès de NAPS. Pour toute demande en ce sens, vous devez vous 
                     adresser à l'e-commerçant.</span>
                  </li>
                  <br />
                  <li style="color: #f37122;"><span
                     style="color: #000 !important;">
                     Pour exercer votre droit de consultation et de rectification de vos données communiquées à l'e-commerçant
                     directement sur son site web, vous devez suivre les modalités précisées par l'e-commerçant et formulées
                     sur son site marchand ou dans ses conditions générales de ventes. NAPS exige un engagement des 
                     e-commerçants affiliés à son service de paiement en ligne de mettre à votre disposition ce droit.
                     Toutefois, il ne saurait être tenu pour responsable si l'e-commerçant ne respecte pas ces engagements légaux.</span>
                  </li>
                  <br />
                  <li style="color: #f37122;"><span
                     style="color: #000 !important;">
                     Les données enregistrées par NAPS sont archivées pendant une durée de 18 mois, car elles constituent
                     une partie de la preuve de la transaction de paiement effectuée par le payeur pour le compte de 
                     l'e-commerçant, et ce, en conformité avec les exigences réglementaires régissant l'activité de NAPS
                     et les exigences contractuelles la liant à l'e-commerçant.</span>
                  </li>
               </ul>
               <button type="submit" id="closeDialog" style="margin-top: 10px;color: #FFF;background: #DF6537;
                  border-radius: 10px;
                  margin-left: auto;
                  width: 160px;
                  border-color: #DF6537;
                  border-top-right-radius: 10px;
                  border-bottom-right-radius: 10px;
                  font-size: 15px;"
                  class="subscribe btn btn-primary btn-block">Fermer
               </button>
            </div>
            <!-- card-body.// -->
         </article>
      </div>
      <div class="container my-2" align="center">
         <footer class="bg-light text-center text-lg-start">
            <!-- Copyright -->
            <div class="text-center cp p-3" style="    border: 0.1px solid #d6d2d2;color: black;">
               Copyright © 2024 Naps Tous droits réservés.
               <a href="https://naps.ma/">naps.ma</a>
            </div>
            <!-- Copyright -->
         </footer>
      </div>
      
    <!-- Popup de traitement en cours -->
    <div id="processingPopup" class="popup" style="display: none;">
        <div class="popup-content">
            <div class="loader"></div>
            <p>Traitement en cours...</p>
        </div>
    </div>

      <script type="text/javascript">
         // ----------------------------
         // Utility Functions
         // ----------------------------

         // Toggle the display style of an element by ID
         function toggleDisplay(elementId, displayStyle) {
            console.info(`Element with ID '${elementId}' not found.`);
            const element = document.getElementById(elementId);
            if (element) {
               element.style.display = displayStyle;
            } else {
               console.error(`Element with ID '${elementId}' not found.`);
            }
         }

         // Limit input field length and allow only numeric values
         function validateInputField(elementId, maxLength) {
            const element = document.getElementById(elementId);
            if (element) {
               element.addEventListener('input', function () {
                  this.value = this.value.slice(0, maxLength).replace(/[^0-9]/g, "");
               });
            } else {
               console.error(`Element with ID '${elementId}' not found for validation.`);
            }
         }

         // Fetch API Wrapper for POST requests
         async function postData(url = '', data = {}) {
            try {
               const response = await fetch(url, {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify(data)
               });
               return response;
            } catch (error) {
               console.error('Error during fetch:', error);
               throw error;
            }
         }

         // ----------------------------
         // Popup Management
         // ----------------------------

         function showProcessingPopup() {
            sessionStorage.setItem('showPopup', 'true');
            toggleDisplay('processingPopup', 'flex');
         }

         function hideProcessingPopup() {
            toggleDisplay('processingPopup', 'none');
         }

         window.onload = function () {
            if (sessionStorage.getItem('showPopup') === 'true') {
               sessionStorage.removeItem('showPopup');
            } else {
               hideProcessingPopup();
            }
         };

         window.onpageshow = function (event) {
            if (event.persisted) {
               console.error('Page loaded from cache. Hiding popup.');
               hideProcessingPopup();
            }
         };

         // ----------------------------
         // Modal Management
         // ----------------------------

         document.body.addEventListener('click', function (event) {
            if (event.target && event.target.id === 'openDialog') {
               toggleDisplay('dialog', 'block');
               console.error('Dialog opened.');
            } else if (event.target && event.target.id === 'closeDialog') {
               toggleDisplay('dialog', 'none');
               console.error('Dialog closed.');
            }
         });

         // ----------------------------
         // Payment Cancellation
         // ----------------------------

		 function cancelPayment() {
		     const iddemande = document.getElementById('iddemande')?.value;
		     if (!iddemande) {
		         console.error('No iddemande found in the hidden input field.');
		         return;
		     }

		     console.log('Cancelling payment with iddemande:', iddemande);

		     postData('/cancelPayment', { iddemande })
		         .then((response) => {
		             if (!response.ok) {
		                 throw new Error('Failed to cancel payment.');
		             }
		             return response.json(); // parse JSON body
		         })
		         .then((data) => {
		             console.log('Cancel response:', data);

		             if (data.failurl) {
		                 // Redirect to the fail URL returned by backend
		                 window.location.href = data.failurl;
		             } else if (data.message) {
		                 alert(data.message); // fallback message
						 if (window.history.length > 1) {
	                              window.history.back();
	                           } else {
	                              window.location.href = '/error';
	                           }
		             }
		         })
		         .catch((error) => {
		             console.error('Error:', error);
		             window.location.href = '/error';
		         });
		 }

         // ----------------------------
         // Input Validation
         // ----------------------------

         validateInputField('cvv', 3);
         validateInputField('num', 19);
         validateInputField('nvnum', 19);

         // ----------------------------
         // Card Expiration Update
         // ----------------------------

         function updateExpirationDate() {
            const selectedCard = document.getElementById('carteID')?.value;
            const yearField = document.getElementById('annee');
            const monthField = document.getElementById('mois');
            const saveCard = document.getElementById('saveCard');
            console.log('selectedCard : ' + selectedCard);
            if (!selectedCard) {
               console.log('No card selected. Resetting fields.');
               if (yearField) yearField.value = '';
               if (monthField) monthField.value = '';
               return;
            }

            const yearMatch = selectedCard.match(/year=(\d+)/);
            const monthMatch = selectedCard.match(/mois=([^,]+)/);

            yearField.value = yearMatch?.[1] || '';
            monthField.value = monthMatch?.[1] || '';
            console.log('yearField : ' + yearField.value);
            console.log('monthField : ' + monthField.value);
            if (monthMatch?.[1] === '0000' || monthMatch?.[1] === 'xxxx') {
               toggleDisplay('nvnums', 'block');
               toggleDisplay('cartes', 'none');
               toggleDisplay('annees', 'none');
               toggleDisplay('nvannes', 'block');
               toggleDisplay('moiss', 'none');
               toggleDisplay('nvmois', 'block');
               toggleDisplay('saveCard', 'block');
            } else {
               toggleDisplay('saveCard', 'none');
            }
         }

         // ----------------------------
         // Toggle New Card Fields
         // ----------------------------

         function toggleNewCardFields() {
            const checkbox = document.getElementById('addNewCardCheckbox');
            if (!checkbox) {
               console.error('Checkbox not found.');
               return;
            }

            if (checkbox.checked) {
               toggleDisplay('nvnums', 'block');
               toggleDisplay('cartes', 'none');
               toggleDisplay('annees', 'none');
               toggleDisplay('nvannes', 'block');
               toggleDisplay('moiss', 'none');
               toggleDisplay('nvmois', 'block');
               toggleDisplay('saveCard', 'block');
            } else {
               toggleDisplay('nvnums', 'none');
               toggleDisplay('cartes', 'block');
               toggleDisplay('annees', 'block');
               toggleDisplay('nvannes', 'none');
               toggleDisplay('moiss', 'block');
               toggleDisplay('nvmois', 'none');
               toggleDisplay('saveCard', 'none');
            }
         }
      window.onload = function() {
          const iddemande = document.getElementById('iddemande');
          const commande = document.getElementById('commande');
          const inputs = document.querySelectorAll('input'); // Sélectionner tous les champs de saisie
          const selects = document.querySelectorAll('select'); // Sélectionner tous les éléments <select>


          // Fonction à appeler quand l'utilisateur touche ou fait défiler la page
          function check() {
              if (iddemande && commande && iddemande.value.trim() !== '' && commande.value.trim() !== '') {
                  console.log("La page est visible, l'utilisateur interagit.");

                  // Effectuer un appel AJAX
                  fetch('/check', {
                      method: 'POST',
                      headers: {
                          'Content-Type': 'application/json'
                      },
                      body: JSON.stringify({
                          iddemande: iddemande.value,
                          commande: commande.value
                      })
                  })
                  .then(response => response.json())
                  .then(data => {
                      console.log("Réponse du serveur :", data);
                  })
                  .catch(error => console.error("Erreur AJAX :", error));
              } else {
                  console.error("Les champs iddemande ou commande sont vides ou introuvables. L'appel AJAX n'a pas été effectué.");
              }
          }

          // Appel initial de check() dès que la page est chargée
          // check();

          // Vérifie si la page est visible (avec l'événement `touchstart` pour mobile et `scroll` pour mobile/desktop)
          function handleUserInteraction() {
              // Si un utilisateur touche ou fait défiler, on appelle la fonction check
              check();
          }

          // Écouter l'événement `touchstart` (sur mobile et tablette)
          document.addEventListener('touchstart', handleUserInteraction, { once: true });

         // Écouter l'événement de clic sur tous les champs input (mobile/desktop)
          inputs.forEach(input => {
              input.addEventListener('click', handleUserInteraction);
          });
           // Écouter l'événement de clic sur tous les éléments <select>
          selects.forEach(select => {
              select.addEventListener('click', handleUserInteraction);
          });

          // Écouter l'événement `scroll` (sur desktop et mobile)
          window.addEventListener('scroll', handleUserInteraction, { once: true });
      };



      </script>
   </body>
</html>